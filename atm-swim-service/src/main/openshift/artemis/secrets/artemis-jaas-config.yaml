apiVersion: v1
kind: Secret
metadata:
  name: sso-jaas-config
type: Opaque
stringData:
  login.config: |
    // a full login.config with the default activemq realm
    activemq {
    
        // ensure the operator can connect to the broker by referencing the existing properties config
        org.apache.activemq.artemis.spi.core.security.jaas.PropertiesLoginModule sufficient
            org.apache.activemq.jaas.properties.user="artemis-users.properties"
            org.apache.activemq.jaas.properties.role="artemis-roles.properties"
            baseDir="/home/jboss/amq-broker/etc";
    
        // Keycloak LoginModule   
        org.keycloak.adapters.jaas.DirectAccessGrantsLoginModule required            
            reload=true
            keycloak-config-file="/amq/extra/secrets/sso-jaas-config/_keycloak-login-module.json"
            role-principal-class="org.apache.activemq.artemis.spi.core.security.jaas.RolePrincipal";
          
        org.apache.activemq.artemis.spi.core.security.jaas.PrincipalConversionLoginModule required
            principalClassList="org.keycloak.KeycloakPrincipal";
    
    };
  _keycloak-login-module.json: |
    {
      "realm": "nav-portugal",
      "auth-server-url": "https://rhbk-nav-portugal.apps.ocp4.masales.cloud",
      "ssl-required": "external",
      "credentials": {
        "secret": "G2I810Drfp1CtnfuJJLGZPtoAErcoVuf"
      },
      "resource": "amq-broker",
      "use-resource-role-mappings": true,
      "principal-attribute": "preferred_username",      
      "confidential-port": 0
    }