# ATM Demo

## Project Description

This project represents the work developed to fulfill a proof of concept with the following definition:

An institution called ATM that has information generically referred to as ATMTopics. These ATMTopics are generated by an internal solution called ATMLegacy with confidential data. ATM must offer this internally generated data to external collaborators known as ATMPartners. It is ATM's responsibility to distribute this data securely and ensure that only properly registered and validated ATMPartners have access to this information. There are some legal requirements that ATM needs to comply with, such as:

* ATM must provide a REST API for ATMPartners to subscribe to ATMTopics of interest.
* ATM must deliver messages about ATMTopics of interest to ATMPartners in a message queue middleware.
* ATM is restricted to using message queues and is not allowed to use topics (from an implementation perspective in the middleware).
* ATM must create a queue per subscription.
* ATM must ensure that the created queues are exclusively consumed by the ATMPartner who requested the subscription.
* ATM must build an environment that supports part of the solution developed in Spring Boot 3, which will be provided by an external institution.

Additionally, ATM presents other challenges such as:

* Establish the credentialing process flow for ATMPartner.
* Define the solution architecture.
* Determine which technologies to use to develop the solution.
* How to deploy the project in a scalable and secure environment.
* How to control the lifecycle of generated artifacts.
* How to train the internal team to be able to maintain the solution.
* Define application models and create reference architectures as well as prototypes for future implementations.


## Sample flows

### Registration Flow Sequence Diagram

```mermaid
sequenceDiagram
    actor A as ATMPartner
    actor B as ATM

    A->>B: Registration Request (essential data)
    activate B
    B->>Keycloak: Register ATMPartner (essential data)
    activate Keycloak
    Keycloak-->>Keycloak: Generates credentials and role
    Keycloak-->>B: Registration Confirmation (user created, credentials)
    B-->>Keycloak: Assigns profiles and roles to the partner
    deactivate Keycloak

    B-->>A: Registration Notification (credentials and role)
    deactivate B

    Note over Keycloak: Role created for A is important for future use
```

### Subscription Flow Sequence Diagram
```mermaid
sequenceDiagram
    actor A as ATMPartner
    participant B as ATM
    participant Keycloak
    participant Database as ATM Database
    participant AMQ

    A->>Keycloak: Authenticate and obtain JWT token
    activate Keycloak
    Keycloak-->>A: Return JWT token
    deactivate Keycloak

    A->>B: Subscribe service request (JWT token, list of ATMTopics)
    activate B

    B->>Keycloak: Validate authentication and authorization (JWT token)
    activate Keycloak
    Keycloak-->>B: Validation result
    deactivate Keycloak

    B->>Database: Create Subscription
    activate Database
    Database-->>B: Subscription created
    deactivate Database

    B->>AMQ: Create message Queue
    activate AMQ
    AMQ-->>B: Message Queue created
    deactivate AMQ

    B->>AMQ: Configure Queue Security for ATMPartner
    AMQ-->>B: Queue Security configured

    B-->>A: Response (Subscription ID, AMQ URL, AMQ port, Queue name, expiration date)
    deactivate B

```

## Build Native Camel Quarkus
```shell
podman build -f docker-images/Dockerfile-camel-quarkus.multistage -t quay.io/masales/atm-camel-quarkus-native:latest .
```

## References
* https://docs.redhat.com/en/documentation/red_hat_amq_broker/7.12
* https://docs.redhat.com/en/documentation/red_hat_amq_broker/7.12/html-single/deploying_amq_broker_on_openshift/index#proc-br-configuring-jaas-login-modules-for-authentication_broker-ocp
* https://docs.redhat.com/en/documentation/red_hat_amq_broker/7.12/html-single/configuring_amq_broker/index#idm139623346509920
* https://docs.redhat.com/en/documentation/red_hat_amq_broker/7.12/html-single/deploying_amq_broker_on_openshift/index#con-br-segregating-broker-properties_broker-ocp
* https://github.com/apache/activemq-artemis-examples
* https://kubernetes.io/docs/tasks/administer-cluster/access-cluster-api/#java-client
* https://github.com/rh-messaging
* https://eur-registry.swim.aero/services/eurocae-arrival-sequence-service-102/arrival-sequence-service-performance-standard
* https://www.eurocontrol.int/publication/eurocontrol-specification-swim-service-description-sd
* https://sparxsystems.com/products/ea/downloads.html
* https://medium.com/javarevisited/keycloak-integration-with-spring-security-6-37999f43ec85
* https://quarkus.io/guides/security-openid-connect-client
* https://quarkus.io/guides/deploying-to-openshift#log-into-the-openshift-cluster